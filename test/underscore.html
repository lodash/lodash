<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Underscore Test Suite</title>
		<link rel="stylesheet" href="../vendor/qunit/qunit/qunit.css">
		<style>
			iframe {
				display: none;
			}
		</style>
	</head>
	<body>
		<div id="qunit"></div>
		<div id="qunit-fixture">
			<div id="map-test">
				<div id="id1"></div>
				<div id="id2"></div>
			</div>
			<img id="chart_image" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
		</div>
		<script src="../vendor/qunit/qunit/qunit.js"></script>
		<script src="../vendor/jquery/jquery.js"></script>
		<script src="../vendor/platform.js/platform.js"></script>
		<script src="test-ui.js"></script>
		<script>
			function init(lodash) {
				var arrayProto = Array.prototype,
				    concat = arrayProto.concat,
				    pop = arrayProto.pop,
				    push = arrayProto.push,
				    slice = arrayProto.slice;

				if (lodash.chain && lodash.chain().__chain__) {
					return;
				}
				lodash.mixin = function(object) {
					lodash.forEach(lodash.functions(object), function(methodName) {
						var func = lodash[methodName] = object[methodName];
						lodash.prototype[methodName] = function() {
							var args = [this.__wrapped__];
							push.apply(args, arguments);

							var result = func.apply(lodash, args);
							if (this.__chain__) {
								result = new lodash(result);
								result.__chain__ = true;
							}
							return result;
						};
					});
				};

				lodash.mixin(lodash);

				lodash.chain = function(value) {
					value = new lodash(value);
					value.__chain__ = true;
					return value;
				};

				lodash.prototype.chain = function() {
					this.__chain__ = true;
					return this;
				};

				lodash.prototype.concat = function() {
					var result = concat.apply(this.__wrapped__, arguments);
					if (this.__chain__) {
						result = new lodash(result);
						result.__chain__ = true;
					}
					return result;
				};

				lodash.prototype.pop = function() {
					pop.apply(this.__wrapped__, arguments);
					return this;
				};

				// expose lodash
				window._ = lodash;
			}

			// load Lo-Dash again to overwrite the existing `_` value
			document.write('<script src="' + ui.buildPath + '"><\/script>');

			// load test.js if not using require.js
			document.write(ui.urlParams.loader != 'none'
				? '<script data-dojo-config="async:1" src="' + ui.loaderPath + '"><\/script>'
				: ([
					'<script src="../vendor/underscore/test/collections.js"><\/script>',
					'<script src="../vendor/underscore/test/arrays.js"><\/script>',
					'<script src="../vendor/underscore/test/functions.js"><\/script>',
					'<script src="../vendor/underscore/test/objects.js"><\/script>',
					'<script src="../vendor/underscore/test/utility.js"><\/script>',
					'<script src="../vendor/underscore/test/chaining.js"><\/script>'
				  ].join('\n'))
			);
		</script>
		<script>
			if (window.curl) {
				var require = curl;
			}
			if (!window.require) {
				init(_);
			} else {
				QUnit.config.autostart = false;

				// load Lo-Dash as a module
				require((function() {
					var reModularize = /modularize/;

					var baseUrl = reModularize.test(ui.urlParams.build)
						? '../modularize/'
						: '';

					var modulePath = reModularize.test(ui.urlParams.build)
						? 'lodash'
						: ui.buildPath.replace(/\.js$/, '');

					return {
						'baseUrl': baseUrl,
						'urlArgs': 't=' + (+new Date),
						'paths': {
							'lodash': modulePath
						}
					};
				}()),
				['lodash'], function(lodash) {
					init(lodash);
					require([
						'../vendor/underscore/test/collections.js',
						'../vendor/underscore/test/arrays.js',
						'../vendor/underscore/test/functions.js',
						'../vendor/underscore/test/objects.js',
						'../vendor/underscore/test/utility.js'
					], function() {
						QUnit.start();
					});
				});
			}
		</script>
		<script type="text/html" id="template">
			<%
			// a comment
			if (data) { data += 12345; }; %>
			<li><%= data %></li>
		</script>
	</body>
</html>
